<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Medicine Locator ‚Äî Kengeri & RR Nagar Nearest</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    #map { height: 420px; width: 100%; }
    .glass { backdrop-filter: blur(12px); background: rgba(255,255,255,0.75); }
    .tab-btn[aria-selected="true"] { background: #10b981; color: white; }
    .chip { border: 1px solid rgba(0,0,0,0.1); padding: .4rem .7rem; border-radius: .75rem; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 via-white to-emerald-50 text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="font-semibold flex items-center gap-2">
        <span class="text-emerald-600">ü©∫</span> Smart Medicine Locator ‚Äî Prototype
      </h1>
      <div class="flex items-center gap-3">
        <span id="helloUser" class="text-sm text-slate-700 hidden"></span>
        <button id="openLogin" class="text-sm px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Login</button>
        <button id="logoutBtn" class="text-sm px-4 py-2 rounded-lg border hover:bg-slate-50 hidden">Logout</button>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="max-w-6xl mx-auto px-4 pb-3">
      <div role="tablist" aria-label="Main Tabs" class="flex gap-2">
        <button class="tab-btn px-4 py-2 rounded-xl border hover:bg-slate-50" role="tab" id="tabbtn-home" aria-controls="tabHome" aria-selected="true">Home</button>
        <button class="tab-btn px-4 py-2 rounded-xl border hover:bg-slate-50" role="tab" id="tabbtn-profile" aria-controls="tabProfile">Profile</button>
        <button class="tab-btn px-4 py-2 rounded-xl border hover:bg-slate-50" role="tab" id="tabbtn-report" aria-controls="tabReport">Report</button>
        <button class="tab-btn px-4 py-2 rounded-xl border hover:bg-slate-50" role="tab" id="tabbtn-settings" aria-controls="tabSettings">Settings</button>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6">
    <!-- TAB: HOME -->
    <section id="tabHome" role="tabpanel" aria-labelledby="tabbtn-home" class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 grid gap-4">
        <!-- Step 0: Search -->
        <div id="stepSearch" class="glass rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold mb-3">1) Search Medicine</h2>
            <div class="flex items-center gap-2 text-sm">
              <button id="setKengeri" class="chip hover:bg-slate-50">üìç Set to Kengeri</button>
              <button id="setRRNagar" class="chip hover:bg-slate-50">üìç Set to RR Nagar</button>
            </div>
          </div>
          <div class="flex gap-3 items-end">
            <div class="flex-1">
              <label class="text-xs text-slate-600">Medicine</label>
              <input id="searchInput" list="medList" type="text" placeholder="e.g., Paracetamol 650 / Dolo 650 / Cetirizine 10"
                     class="w-full px-6 py-4 text-3xl rounded-2xl border focus:outline-none focus:ring-2 focus:ring-emerald-300"
                     autocomplete="off"/>
              <datalist id="medList"></datalist>
            </div>
            <button id="goStepRadius" class="px-5 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
              Next: Radius ‚Üí
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-2">Tip: Press Enter to jump ahead.</p>
        </div>

        <!-- Step 1: Radius -->
        <div id="stepRadius" class="glass rounded-2xl shadow p-4 hidden">
          <h2 class="font-semibold mb-3">2) Choose Radius</h2>
          <div class="flex flex-wrap items-center gap-3">
            <select id="radiusSelect" class="px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-100">
              <option value="0.5">0.5 km</option>
              <option value="1" selected>1 km</option>
              <option value="2">2 km</option>
              <option value="5">5 km</option>
              <option value="any">Any distance</option>
            </select>

            <div class="ml-auto flex gap-2">
              <button id="backToSearch" class="px-4 py-2 rounded-lg border hover:bg-slate-50">‚Üê Back</button>
              <button id="goStepNearest" class="px-5 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
                Next: Nearest ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: Nearest -->
        <div id="stepNearest" class="glass rounded-2xl shadow p-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">3) Nearest Store</h2>
            <div class="text-sm text-slate-500">Result <span id="nearIdx">0</span>/<span id="nearTotal">0</span></div>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="nearPrev" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">‚Üê Previous</button>
            <button id="nearNext" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Next ‚Üí</button>
            <div class="ml-auto flex gap-2">
              <button id="backToRadius" class="px-4 py-1.5 rounded-lg border hover:bg-slate-50">‚Üê Back</button>
              <button id="goStepCheapest" class="px-5 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Next: Cheapest ‚Üí</button>
            </div>
          </div>
          <div id="nearResult" class="rounded-xl border p-3 bg-white/80"></div>
        </div>

        <!-- Step 3: Cheapest -->
        <div id="stepCheapest" class="glass rounded-2xl shadow p-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">4) Cheapest In-Stock</h2>
            <div class="text-sm text-slate-500">Result <span id="cheapIdx">0</span>/<span id="cheapTotal">0</span></div>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="cheapPrev" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">‚Üê Previous</button>
            <button id="cheapNext" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Next ‚Üí</button>
            <div class="ml-auto">
              <button id="backToNearest" class="px-4 py-1.5 rounded-lg border hover:bg-slate-50">‚Üê Back</button>
            </div>
          </div>
          <div id="cheapResult" class="rounded-xl border p-3 bg-white/80"></div>
        </div>
      </div>

      <!-- Map -->
      <aside class="glass rounded-2xl shadow p-4">
        <h3 class="font-semibold mb-2">Map</h3>
        <div id="map" class="rounded-xl overflow-hidden"></div>
        <p id="geoStatus" class="text-xs text-slate-500 mt-2">Loading map‚Ä¶</p>
      </aside>
    </section>

    <!-- TAB: PROFILE -->
    <section id="tabProfile" role="tabpanel" aria-labelledby="tabbtn-profile" class="hidden">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Login Data -->
        <div class="glass rounded-2xl shadow p-4">
          <h2 class="font-semibold mb-3">Profile</h2>
          <div id="profileInfo" class="text-sm space-y-1"></div>
        </div>

        <!-- Search History -->
        <div class="glass rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Medicine Search History</h2>
            <button id="clearHistory" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Clear</button>
          </div>
          <ul id="historyList" class="text-sm divide-y"></ul>
        </div>
      </div>
    </section>

    <!-- TAB: REPORT -->
    <section id="tabReport" role="tabpanel" aria-labelledby="tabbtn-report" class="hidden">
      <div class="glass rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Report</h2>
          <div class="flex gap-2">
            <button id="saveReport" class="px-4 py-2 rounded-lg border hover:bg-slate-50">Save</button>
            <button id="downloadReport" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Download .txt</button>
          </div>
        </div>
        <textarea id="reportText" class="w-full h-72 p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-200" placeholder="Write your report here..."></textarea>
        <p id="reportStatus" class="text-xs text-slate-500 mt-2">Not saved yet.</p>
      </div>
    </section>

    <!-- TAB: SETTINGS -->
    <section id="tabSettings" role="tabpanel" aria-labelledby="tabbtn-settings" class="hidden">
      <div class="glass rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-3">Settings</h2>
        <p id="settingsStatus" class="text-sm text-slate-600 mb-4">Checking login status‚Ä¶</p>
        <div class="flex flex-wrap gap-3">
          <button id="settingsLogin" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Login</button>
          <button id="settingsLogout" class="px-4 py-2 rounded-lg border hover:bg-slate-50">Logout</button>

          <!-- Location button with symbol (kept from previous step) -->
          <button id="settingsLocate" class="px-4 py-2 rounded-lg border hover:bg-slate-50 flex items-center gap-2">
            <span aria-hidden="true">üìç</span>
            <span>Use Current Location & Find Nearest</span>
          </button>
        </div>
        <p id="settingsNearest" class="text-sm text-slate-600 mt-3"></p>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4 z-50">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Welcome! Please Login</h2>
        <button id="closeLogin" class="text-slate-500 hover:text-slate-700 text-2xl" aria-label="Close login">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Phone Number *</label>
          <input id="phone" type="tel" placeholder="Enter 10-digit phone number"
                 class="w-full px-4 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-300" inputmode="numeric" pattern="[0-9]*"/>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Email (Gmail preferred) *</label>
          <input id="email" type="email" placeholder="yourname@gmail.com"
                 class="w-full px-4 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-300"/>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Your Name (Optional)</label>
          <input id="name" type="text" placeholder="Enter your name"
                 class="w-full px-4 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-300"/>
        </div>

        <button id="saveLogin" class="w-full mt-2 px-4 py-3 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">
          Continue ‚Üí
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (s) => document.querySelector(s);
    const km = (m) => (m/1000);
    const formatRs = (x) => `‚Çπ${(+x).toFixed(2)}`;
    const gdir = (o, d) =>
      `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(o.lat+','+o.lng)}&destination=${encodeURIComponent(d.lat+','+d.lng)}&travelmode=driving`;
    const fmtDT = (ts) => new Date(ts).toLocaleString();

    function distM(a, b){
      const R = 6371e3, toRad = (d) => d*Math.PI/180;
      const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
    }

    // ---------- Leaflet icon fix ----------
    (function fixLeafletIcons(){
      const base = 'https://unpkg.com/leaflet@1.9.4/dist/images/';
      L.Icon.Default.mergeOptions({
        iconRetinaUrl: base + 'marker-icon-2x.png',
        iconUrl: base + 'marker-icon.png',
        shadowUrl: base + 'marker-shadow.png',
      });
    })();

    // ---------- Pharmacies (added Kengeri + RR Nagar) ----------
    const PHARMACIES = [
      // Core city list (trimmed from earlier answer to keep focus)
      { id: 1, name: 'MedPlus Indiranagar', phone:'+91-8022221111', lat:12.9719, lng:77.6412, rating:4.4,
        inventory:{'Paracetamol 650':{price:22,stock:25}, 'Dolo 650':{price:28,stock:35}, 'Azithromycin 500':{price:82,stock:8}, 'Cetirizine 10':{price:15,stock:40}, 'Pantoprazole 40':{price:32,stock:20}, 'Amoxicillin 500':{price:68,stock:10}, 'ORS Sachet':{price:18,stock:50}} },
      { id: 2, name: 'Apollo Pharmacy MG Road', phone:'+91-8022222222', lat:12.9738, lng:77.6113, rating:4.2,
        inventory:{'Paracetamol 650':{price:24,stock:2}, 'Dolo 650':{price:27,stock:12}, 'Metformin 500':{price:16,stock:30}, 'Atorvastatin 10':{price:55,stock:10}, 'Cough Syrup 100ml':{price:75,stock:9}} },

      // ---- Kengeri area (approx coordinates) ----
      { id: 101, name: 'MedPlus Kengeri', phone:'+91-8028001101', lat:12.9098, lng:77.4858, rating:4.3,
        inventory:{'Paracetamol 650':{price:22.5,stock:30}, 'Dolo 650':{price:27.5,stock:25}, 'Cetirizine 10':{price:14,stock:60}, 'Pantoprazole 40':{price:31,stock:20}, 'Amoxicillin 500':{price:67,stock:8}} },
      { id: 102, name: 'Apollo Pharmacy Kengeri Satellite Town', phone:'+91-8028001102', lat:12.9130, lng:77.4905, rating:4.2,
        inventory:{'Paracetamol 650':{price:23,stock:22}, 'Dolo 650':{price:27,stock:18}, 'Azithromycin 500':{price:79,stock:7}, 'ORS Sachet':{price:17,stock:80}} },
      { id: 103, name: 'Sri Lakshmi Medicals Kengeri', phone:'+91-8028001103', lat:12.9075, lng:77.4812, rating:4.1,
        inventory:{'Paracetamol 650':{price:21.9,stock:28}, 'Metformin 500':{price:15.5,stock:40}, 'Cough Syrup 100ml':{price:72,stock:10}, 'Dolo 650':{price:26.5,stock:16}} },

      // ---- Rajarajeshwari Nagar (approx coordinates) ----
      { id: 111, name: 'MedPlus Rajarajeshwari Nagar', phone:'+91-8028001111', lat:12.9258, lng:77.5065, rating:4.3,
        inventory:{'Paracetamol 650':{price:22.0,stock:35}, 'Dolo 650':{price:26.8,stock:20}, 'Cetirizine 10':{price:13.8,stock:70}, 'Pantoprazole 40':{price:30,stock:18}} },
      { id: 112, name: 'Apollo Pharmacy RR Nagar', phone:'+91-8028001112', lat:12.9302, lng:77.5091, rating:4.2,
        inventory:{'Paracetamol 650':{price:23.2,stock:24}, 'Dolo 650':{price:27.2,stock:14}, 'Azithromycin 500':{price:78,stock:6}, 'Amoxicillin 500':{price:68,stock:9}} },
      { id: 113, name: 'Sri Raghavendra Medicals RR Nagar', phone:'+91-8028001113', lat:12.9220, lng:77.5015, rating:4.0,
        inventory:{'Paracetamol 650':{price:22.8,stock:26}, 'Dolo 650':{price:27.0,stock:18}, 'ORS Sachet':{price:16.5,stock:90}, 'Cough Syrup 100ml':{price:70,stock:8}} },

      // A couple more core entries so map has context
      { id: 3, name: '1MG Wellness Koramangala', phone:'+91-8033333333', lat:12.9345, lng:77.6141, rating:4.5,
        inventory:{'Paracetamol 650':{price:26,stock:20}, 'Dolo 650':{price:29,stock:0}, 'Metformin 500':{price:15,stock:14}, 'Azithromycin 500':{price:78,stock:6}, 'Vitamin C 500':{price:45,stock:25}, 'Zinc 50':{price:28,stock:30}} },
      { id: 4, name: 'Netmeds Residency Road', phone:'+91-8044444444', lat:12.9689, lng:77.6046, rating:4.1,
        inventory:{'Paracetamol 650':{price:23,stock:0}, 'Dolo 650':{price:26,stock:20}, 'ORS Sachet':{price:18,stock:40}, 'Atorvastatin 10':{price:53,stock:5}, 'Omeprazole 20':{price:25,stock:16}} },
    ];

    const MEDICINE_NAMES = [...new Set(PHARMACIES.flatMap(p => Object.keys(p.inventory)))].sort();

    // ---------- State ----------
    let map, userMarker, accuracyCircle;
    let userLoc = { lat:12.9716, lng:77.5946 }; // default Bengaluru
    let nearestRows = [], nearIdx = 0;
    let cheapestRows = [], cheapIdx = 0;

    // ---------- Storage helpers ----------
    function getUser(){ try { return JSON.parse(localStorage.getItem('sml_user')||'null'); } catch { return null; } }
    function setUser(u){ localStorage.setItem('sml_user', JSON.stringify(u)); }
    function clearUser(){ localStorage.removeItem('sml_user'); }
    function getHistory(){ try { return JSON.parse(localStorage.getItem('sml_history')||'[]'); } catch { return []; } }
    function setHistory(arr){ localStorage.setItem('sml_history', JSON.stringify(arr)); }
    function pushHistory(entry){
      const arr = getHistory(); arr.unshift(entry); if (arr.length>50) arr.length=50; setHistory(arr);
    }
    function getReport(){ return localStorage.getItem('sml_report') || ''; }
    function setReport(text){ localStorage.setItem('sml_report', text); }

    // ---------- Map ----------
    function initMap(){
      map = L.map('map').setView([userLoc.lat, userLoc.lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
      userMarker = L.marker([userLoc.lat, userLoc.lng]).addTo(map).bindPopup('Your location');
      accuracyCircle = L.circle([userLoc.lat, userLoc.lng], { radius: 80, color:'#60a5fa', fillColor:'#93c5fd', fillOpacity:0.25 }).addTo(map);

      $('#geoStatus').textContent = `Location: ${userLoc.lat.toFixed(4)}, ${userLoc.lng.toFixed(4)} (waiting for GPS‚Ä¶)`;
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          updateLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
        }, ()=>{}, { enableHighAccuracy:true, timeout:8000 });
      }
    }

    function updateLocation(lat, lng, accuracy){
      userLoc = { lat, lng };
      const acc = Math.min(Math.max(accuracy||60,10), 200);
      userMarker.setLatLng([lat, lng]);
      accuracyCircle.setLatLng([lat, lng]).setRadius(acc);
      map.setView([lat, lng], 13);
      $('#geoStatus').textContent = `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)} ‚Ä¢ ¬±${Math.round(acc)} m`;
    }

    function putStoreMarkers(rows, query){
      const toRemove = [];
      map.eachLayer((layer)=>{
        if (layer instanceof L.Marker && layer !== userMarker){ toRemove.push(layer); }
        if (layer instanceof L.Popup){ toRemove.push(layer); }
      });
      toRemove.forEach(l=>map.removeLayer(l));

      rows.forEach((p, i)=>{
        L.marker([p.lat, p.lng]).addTo(map)
          .bindPopup(`<b>${i+1}. ${p.name}</b><br>‚≠ê ${p.rating}<br>${formatRs(p.inventory[query].price)} ‚Ä¢ ${km(p._dist).toFixed(2)} km`);
      });
      if (rows.length){
        const g = L.featureGroup(rows.map(p=>L.marker([p.lat,p.lng])));
        map.fitBounds(g.getBounds().pad(0.2));
      }
    }

    // ---------- COMMON SEARCH ----------
    function runCommonSearch(query, radiusValue, mode){
      const q = (query||'').trim();
      if (!q){ alert('Enter a medicine name'); return []; }

      let rows = PHARMACIES.filter(p => p.inventory[q]);
      rows = rows.map(p => ({...p, _dist: distM(userLoc, {lat:p.lat, lng:p.lng})}));

      if (radiusValue !== 'any'){
        const rKm = parseFloat(radiusValue);
        rows = rows.filter(p => km(p._dist) <= rKm);
      }

      if (mode === 'nearest'){
        rows.sort((a,b)=> a._dist - b._dist);
      } else if (mode === 'cheapest'){
        rows = rows.filter(p => p.inventory[q].stock > 0);
        rows.sort((a,b)=> a.inventory[q].price - b.inventory[q].price || a._dist - b._dist);
      } else {
        rows.sort((a,b)=>{
          const ia=a.inventory[q], ib=b.inventory[q];
          const sa=ia.stock>0?0:1, sb=ib.stock>0?0:1;
          if (sa!==sb) return sa-sb;
          if (ia.price!==ib.price) return ia.price-ib.price;
          return a._dist-b._dist;
        });
      }

      putStoreMarkers(rows, q);
      return rows;
    }

    // ---------- Render helpers ----------
    function storeCard(p, q){
      const inv = p.inventory[q];
      const dkm = km(p._dist).toFixed(2);
      return `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold">${p.name}</div>
            <div class="text-xs text-slate-600">‚≠ê ${p.rating} ‚Ä¢ ${dkm} km away</div>
            <div class="text-xs text-slate-500 mt-1">Phone: ${p.phone||'-'}</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-semibold">${formatRs(inv.price)}</div>
            <div class="text-xs ${inv.stock>0?'text-emerald-600':'text-rose-600'}">
              ${inv.stock>0?`In stock: ${inv.stock}`:'Out of stock'}
            </div>
          </div>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <a class="px-3 py-1.5 rounded-lg border hover:bg-slate-50" href="${gdir(userLoc,{lat:p.lat,lng:p.lng})}" target="_blank" rel="noopener">Directions</a>
          <button class="px-3 py-1.5 rounded-lg border hover:bg-slate-50" data-focus="${p.id}">Show on map</button>
          ${p.phone?`<a class="px-3 py-1.5 rounded-lg border hover:bg-slate-50" href="tel:${p.phone}">Call</a>`:''}
        </div>
      `;
    }

    function bindFocusButtons(containerId, rows){
      const wrap = $(containerId);
      wrap.querySelectorAll('[data-focus]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = +btn.getAttribute('data-focus');
          const p = rows.find(r=>r.id===id);
          if (!p) return;
          map.setView([p.lat,p.lng], 16);
          L.popup().setLatLng([p.lat,p.lng]).setContent(`<b>${p.name}</b>`).openOn(map);
        });
      });
    }

    // ---------- Steps logic ----------
    function showOnlySteps(ids){
      ['stepSearch','stepRadius','stepNearest','stepCheapest'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (ids.includes(id)) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });
    }

    function initSteps(){
      const searchInput = $('#searchInput');
      const radiusSelect = $('#radiusSelect');

      // autocomplete list
      const dl = $('#medList');
      MEDICINE_NAMES.forEach(n=>{
        const opt=document.createElement('option');
        opt.value=n; dl.appendChild(opt);
      });

      const last = localStorage.getItem('sml_last_query');
      if (last) searchInput.value = last;

      // STEP 0 ‚Üí STEP 1
      $('#goStepRadius').addEventListener('click', ()=>{
        if (!searchInput.value.trim()){ alert('Enter a medicine name'); return; }
        localStorage.setItem('sml_last_query', searchInput.value.trim());
        showOnlySteps(['stepRadius']);
        radiusSelect.focus();
      });

      searchInput.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){ $('#goStepRadius').click(); }
      });

      $('#backToSearch').addEventListener('click', ()=>{
        showOnlySteps(['stepSearch']);
        searchInput.focus();
      });

      // STEP 1 ‚Üí STEP 2 (Nearest)
      function goNearest(){
        const q = searchInput.value.trim();
        const r = radiusSelect.value;
        nearestRows = runCommonSearch(q, r, 'nearest');
        nearIdx = 0;
        if (!nearestRows.length){ alert('No stores found for selected radius.'); return; }
        renderNearest();
        pushHistory({ q, radius: r, ts: Date.now() });
        showOnlySteps(['stepNearest']);
      }

      $('#goStepNearest').addEventListener('click', goNearest);
      radiusSelect.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') goNearest();
      });

      $('#backToRadius').addEventListener('click', ()=>{
        showOnlySteps(['stepRadius']);
        radiusSelect.focus();
      });

      // Nearest nav
      $('#nearPrev').addEventListener('click', ()=>{ if (nearIdx>0){ nearIdx--; renderNearest(); } });
      $('#nearNext').addEventListener('click', ()=>{ if (nearIdx<nearestRows.length-1){ nearIdx++; renderNearest(); } });

      // STEP 2 ‚Üí STEP 3 (Cheapest)
      $('#goStepCheapest').addEventListener('click', ()=>{
        const q = searchInput.value.trim();
        const r = radiusSelect.value;
        cheapestRows = runCommonSearch(q, r, 'cheapest');
        cheapIdx = 0;
        if (!cheapestRows.length){ alert('No in-stock stores found in selected radius.'); return; }
        renderCheapest();
        showOnlySteps(['stepCheapest']);
      });

      $('#backToNearest').addEventListener('click', ()=>{
        showOnlySteps(['stepNearest']);
      });

      function renderNearest(){
        $('#nearTotal').textContent = nearestRows.length;
        $('#nearIdx').textContent = nearIdx+1;
        const p = nearestRows[nearIdx];
        $('#nearResult').innerHTML = storeCard(p, searchInput.value.trim());
        bindFocusButtons('#nearResult', nearestRows);
      }

      function renderCheapest(){
        $('#cheapTotal').textContent = cheapestRows.length;
        $('#cheapIdx').textContent = cheapIdx+1;
        const p = cheapestRows[cheapIdx];
        $('#cheapResult').innerHTML = storeCard(p, searchInput.value.trim());
        bindFocusButtons('#cheapResult', cheapestRows);
      }
    }

    // ---------- Tabs ----------
    function setActiveTab(id){
      ['tabHome','tabProfile','tabReport','tabSettings'].forEach(tab=>{
        const el = document.getElementById(tab);
        if (tab === id) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      ['home','profile','report','settings'].forEach(name=>{
        const b = document.getElementById('tabbtn-' + name);
        b.setAttribute('aria-selected', (('tab' + name.charAt(0).toUpperCase()+name.slice(1)) === id) ? 'true':'false');
      });
      if (id === 'tabHome' && map){ setTimeout(()=> map.invalidateSize(), 80); }
      if (id === 'tabProfile'){ renderProfile(); }
      if (id === 'tabReport'){ renderReport(); }
      if (id === 'tabSettings'){ renderSettings(); }
    }

    function initTabs(){
      $('#tabbtn-home').addEventListener('click', ()=> setActiveTab('tabHome'));
      $('#tabbtn-profile').addEventListener('click', ()=> setActiveTab('tabProfile'));
      $('#tabbtn-report').addEventListener('click', ()=> setActiveTab('tabReport'));
      $('#tabbtn-settings').addEventListener('click', ()=> setActiveTab('tabSettings'));
    }

    // ---------- Profile ----------
    function renderProfile(){
      const user = getUser();
      const box = $('#profileInfo');
      if (user){
        box.innerHTML = `
          <div><span class="text-slate-500">Name:</span> ${user.name || '-'}</div>
          <div><span class="text-slate-500">Phone:</span> ${user.phone}</div>
          <div><span class="text-slate-500">Email:</span> ${user.email}</div>
          <div><span class="text-slate-500">Signed in:</span> ${fmtDT(user.ts)}</div>
        `;
      } else {
        box.innerHTML = `
          <div class="text-slate-600">You are not logged in.</div>
          <button class="mt-2 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" id="profileLoginBtn">Login</button>
        `;
        const btn = $('#profileLoginBtn');
        if (btn) btn.addEventListener('click', ()=>{
          $('#loginModal').classList.remove('hidden'); $('#loginModal').classList.add('flex');
        });
      }

      const list = $('#historyList');
      const hist = getHistory();
      if (!hist.length){
        list.innerHTML = `<li class="py-3 text-slate-500">No searches yet.</li>`;
      } else {
        list.innerHTML = hist.map(h => `
          <li class="py-3 flex items-center justify-between">
            <div>
              <div class="font-medium">${h.q}</div>
              <div class="text-xs text-slate-500">Radius: ${h.radius} ‚Ä¢ ${fmtDT(h.ts)}</div>
            </div>
            <button class="px-3 py-1 rounded-lg border hover:bg-slate-50" data-replay="${h.q}|${h.radius}">Search again</button>
          </li>
        `).join('');
        list.querySelectorAll('[data-replay]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const [q,r] = btn.getAttribute('data-replay').split('|');
            setActiveTab('tabHome');
            $('#searchInput').value = q;
            $('#radiusSelect').value = r;
            document.getElementById('goStepNearest').click();
          });
        });
      }

      $('#clearHistory').addEventListener('click', ()=>{
        if (confirm('Clear your medicine search history?')){
          setHistory([]);
          renderProfile();
        }
      });
    }

    // ---------- Report ----------
    function renderReport(){
      const t = getReport();
      $('#reportText').value = t;
      setReportStatus(t ? 'Loaded saved report.' : 'Not saved yet.');
    }
    function setReportStatus(msg){ $('#reportStatus').textContent = msg; }
    function initReport(){
      $('#saveReport').addEventListener('click', ()=>{
        setReport($('#reportText').value);
        setReportStatus('Saved at ' + new Date().toLocaleTimeString());
      });
      let deb; $('#reportText').addEventListener('input', ()=>{
        clearTimeout(deb);
        deb = setTimeout(()=>{
          setReport($('#reportText').value);
          setReportStatus('Autosaved at ' + new Date().toLocaleTimeString());
        }, 600);
      });
      $('#downloadReport').addEventListener('click', ()=>{
        const blob = new Blob([$('#reportText').value], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'medicine_report.txt';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    }

    // ---------- Settings ----------
    function renderSettings(){
      const u = getUser();
      $('#settingsStatus').textContent = u ? `Logged in as ${u.name || u.phone || u.email}` : 'You are not logged in.';
    }
    function initSettings(){
      $('#settingsLogin').addEventListener('click', ()=>{
        $('#loginModal').classList.remove('hidden'); $('#loginModal').classList.add('flex');
      });
      $('#settingsLogout').addEventListener('click', ()=>{
        clearUser();
        location.reload();
      });

      // Use current geolocation and directly find nearest for typed medicine
      $('#settingsLocate').addEventListener('click', ()=>{
        const q = $('#searchInput').value.trim();
        if (!q){ alert('Enter a medicine name in Home ‚Üí Search first.'); return; }
        if (!navigator.geolocation){ alert('Geolocation not supported on this device.'); return; }
        navigator.geolocation.getCurrentPosition((pos)=>{
          updateLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
          setActiveTab('tabHome');
          // auto-run nearest with ANY radius so you see something
          $('#radiusSelect').value = 'any';
          const rows = runCommonSearch(q, 'any', 'nearest');
          if (!rows.length){ alert('No stores carry this medicine near your location.'); return; }
          // jump into Step Nearest
          nearestRows = rows; nearIdx = 0;
          document.getElementById('stepNearest').classList.remove('hidden');
          document.getElementById('stepSearch').classList.add('hidden');
          document.getElementById('stepRadius').classList.add('hidden');
          renderNearestInline();
        }, (err)=>{
          alert('Could not get current location. Please allow permission and try again.');
          console.warn(err);
        }, { enableHighAccuracy:true, timeout:8000 });
      });

      function renderNearestInline(){
        const q = $('#searchInput').value.trim();
        $('#nearTotal').textContent = nearestRows.length;
        $('#nearIdx').textContent = nearIdx+1;
        const p = nearestRows[nearIdx];
        $('#nearResult').innerHTML = storeCard(p, q);
        bindFocusButtons('#nearResult', nearestRows);
      }
    }

    // ---------- Login ----------
    function setupLogin(){
      function showLoggedIn({ name, phone, email }){
        const label = name || phone || email || 'User';
        $('#helloUser').textContent = `Hi, ${label}!`;
        $('#helloUser').classList.remove('hidden');
        $('#openLogin').classList.add('hidden');
        $('#logoutBtn').classList.remove('hidden');
      }

      function checkLogin(){
        const saved = getUser();
        if (saved){ showLoggedIn(saved); }
      }

      $('#openLogin').addEventListener('click', ()=>{
        $('#loginModal').classList.remove('hidden'); $('#loginModal').classList.add('flex');
      });
      $('#closeLogin').addEventListener('click', ()=>{
        $('#loginModal').classList.add('hidden'); $('#loginModal').classList.remove('flex');
      });

      $('#saveLogin').addEventListener('click', ()=>{
        const phone = $('#phone').value.trim();
        const email = $('#email').value.trim();
        const name  = $('#name').value.trim();
        if (!/^\d{10}$/.test(phone)) { alert('Please enter a valid 10-digit phone number'); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('Please enter a valid email address'); return; }
        const user = { phone, email, name, ts: Date.now() };
        setUser(user);
        $('#loginModal').classList.add('hidden'); $('#loginModal').classList.remove('flex');
        const label = name || phone;
        $('#helloUser').textContent = `Hi, ${label}!`;
        $('#helloUser').classList.remove('hidden');
        $('#openLogin').classList.add('hidden');
        $('#logoutBtn').classList.remove('hidden');
        renderSettings();
        renderProfile();
      });

      $('#logoutBtn').addEventListener('click', ()=>{
        clearUser();
        location.reload();
      });

      checkLogin();
    }

    // ---------- Locality presets (Kengeri / RR Nagar) ----------
    function setPresetLocation(name){
      let loc;
      if (name === 'kengeri'){ loc = { lat:12.9092, lng:77.4840 }; }
      if (name === 'rrnagar'){ loc = { lat:12.9250, lng:77.5040 }; }
      if (!loc) return;
      updateLocation(loc.lat, loc.lng, 80);
      // Highlight on map
      L.popup().setLatLng([loc.lat, loc.lng]).setContent(`<b>${name === 'kengeri' ? 'Kengeri' : 'Rajarajeshwari Nagar'}</b><br>Location set.`).openOn(map);
      // Inform user
      $('#geoStatus').textContent += ` ‚Ä¢ Preset: ${name === 'kengeri' ? 'Kengeri' : 'RR Nagar'}`;
    }

    function initPresets(){
      $('#setKengeri').addEventListener('click', ()=>{
        setPresetLocation('kengeri');
        // If a medicine is already typed, directly guide user into nearest search
        const q = $('#searchInput').value.trim();
        if (q){
          $('#radiusSelect').value = 'any';
          const rows = runCommonSearch(q, 'any', 'nearest');
          if (rows.length){
            nearestRows = rows; nearIdx = 0;
            showOnlySteps(['stepNearest']);
            // render card
            $('#nearTotal').textContent = nearestRows.length;
            $('#nearIdx').textContent = nearIdx+1;
            $('#nearResult').innerHTML = storeCard(nearestRows[0], q);
            bindFocusButtons('#nearResult', nearestRows);
          }
        }
      });

      $('#setRRNagar').addEventListener('click', ()=>{
        setPresetLocation('rrnagar');
        const q = $('#searchInput').value.trim();
        if (q){
          $('#radiusSelect').value = 'any';
          const rows = runCommonSearch(q, 'any', 'nearest');
          if (rows.length){
            nearestRows = rows; nearIdx = 0;
            showOnlySteps(['stepNearest']);
            $('#nearTotal').textContent = nearestRows.length;
            $('#nearIdx').textContent = nearIdx+1;
            $('#nearResult').innerHTML = storeCard(nearestRows[0], q);
            bindFocusButtons('#nearResult', nearestRows);
          }
        }
      });
    }

    // ---------- Boot ----------
    window.addEventListener('DOMContentLoaded', ()=>{
      setupLogin();
      initMap();
      initSteps();
      initTabs();
      initReport();
      initSettings();
      initPresets();
      $('#searchInput').focus();
      setActiveTab('tabHome');
    });
  </script>
</body>
</html>
